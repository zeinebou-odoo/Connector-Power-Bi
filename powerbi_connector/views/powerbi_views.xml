<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        <!-- Vue formulaire pour powerbi.settings -->
        <record id="view_powerbi_settings_form" model="ir.ui.view">
            <field name="name">powerbi.settings.form</field>
            <field name="model">powerbi.settings</field>
            <field name="arch" type="xml">
                <form string="Configuration Power BI">
                    <header>
                        <button name="action_generate_token" type="object" string="Générer Token" class="btn-primary" 
                                invisible="token"/>
                        <button name="action_test_aad_connection" type="object" string="Tester AAD" class="btn-warning"
                                invisible="not token"/>
                        <button name="action_test_connection" type="object" string="Tester Connexion" class="btn-secondary"
                                invisible="not token"/>
                        <button name="action_sync_workspaces" type="object" string="Synchroniser Workspaces" class="btn-info"
                                invisible="not token"/>
                        <field name="is_active" widget="boolean_toggle"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="Nom de la configuration"/>
                            </h1>
                        </div>
                        <group>
                            <group string="Configuration API">
                                <field name="token" readonly="1" password="True"/>
                                <field name="max_records"/>
                                <field name="tenant_id"/>
                                <field name="client_id"/>
                                <field name="client_secret" password="True"/>
                                <field name="default_access_level"/>
                            </group>
                            <group string="Informations">
                                <field name="created_date" readonly="1"/>
                                <field name="last_used" readonly="1"/>
                            </group>
                        </group>
                        <group string="Modèles autorisés">
                            <field name="allowed_models" placeholder="res.partner&#10;account.move&#10;sale.order"/>
                        </group>
                        <div class="alert alert-info" role="alert">
                            <strong>Instructions d'utilisation :</strong><br/>
                            • Générez un token d'authentification<br/>
                            • Liste les modèles Odoo autorisés (un par ligne)<br/>
                            • Utilisez le token dans les en-têtes HTTP : X-PowerBI-Token: &lt;token&gt;<br/>
                            • Ou comme paramètre d'URL : ?token=&lt;token&gt;
                        </div>
                        <div class="alert alert-warning" role="alert">
                            <strong>Configuration Azure AD pour Power BI :</strong><br/>
                            • Créez une application dans Microsoft Entra ID (entra.microsoft.com)<br/>
                            • Récupérez Tenant ID, Client ID et Client Secret<br/>
                            • Ajoutez les autorisations d'application Power BI : Report.Read.All, Dataset.Read.All, Workspace.Read.All<br/>
                            • Accordez le consentement d'administrateur<br/>
                            • Dans Power BI Admin portal, activez "Autoriser les principaux de service à utiliser les API Power BI"<br/>
                            • Ajoutez l'application aux workspaces Power BI (Membre/Contributeur + Build sur datasets)
                        </div>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Vue liste pour powerbi.settings -->
        <record id="view_powerbi_settings_tree" model="ir.ui.view">
            <field name="name">powerbi.settings.tree</field>
            <field name="model">powerbi.settings</field>
            <field name="arch" type="xml">
                <list string="Configurations Power BI">
                    <field name="name"/>
                    <field name="is_active"/>
                    <field name="token" password="True"/>
                    <field name="max_records"/>
                    <field name="created_date"/>
                    <field name="last_used"/>
                </list>
            </field>
        </record>

        <!-- Vue recherche pour powerbi.settings -->
        <record id="view_powerbi_settings_search" model="ir.ui.view">
            <field name="name">powerbi.settings.search</field>
            <field name="model">powerbi.settings</field>
            <field name="arch" type="xml">
                <search string="Rechercher Configurations">
                    <field name="name"/>
                    <filter string="Actifs" name="active" domain="[('is_active', '=', True)]"/>
                    <filter string="Inactifs" name="inactive" domain="[('is_active', '=', False)]"/>
                    <group expand="0" string="Regrouper par">
                        <filter string="Statut" name="group_by_status" context="{'group_by': 'is_active'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Action pour ouvrir les configurations -->
        <record id="action_powerbi_settings" model="ir.actions.act_window">
            <field name="name">Configurations Power BI</field>
            <field name="res_model">powerbi.settings</field>
            <field name="view_mode">list,form</field>
            <field name="context">{'search_default_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créez votre première configuration Power BI
                </p>
                <p>
                    Configurez les paramètres pour connecter Odoo à Power BI.
                </p>
            </field>
        </record>

        <!-- Menu principal Power BI (root) avec sous-menu imbriqué conforme au schéma -->
        <menuitem id="menu_powerbi_root"
                  name="Power BI"
                  sequence="60"
                  web_icon="base,static/description/modules.png">
            <menuitem id="menu_powerbi_settings"
                      name="Configurations"
                      action="action_powerbi_settings"
                      sequence="10"/>
        </menuitem>
    </data>
</odoo>